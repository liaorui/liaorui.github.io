<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Java">
<meta property="og:type" content="website">
<meta property="og:title" content="TechLiving">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="TechLiving">
<meta property="og:description" content="Java">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="TechLiving">
<meta name="twitter:description" content="Java">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>TechLiving</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">TechLiving</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Technology and Life</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/13/Mac上搭建Hadoop-Hive-Spark开发环境/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liao Rui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TechLiving">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/13/Mac上搭建Hadoop-Hive-Spark开发环境/" itemprop="url">Mac上搭建Hadoop+Hive+Spark开发环境</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-13T10:14:37+08:00">
                2018-04-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/13/Mac上搭建Hadoop-Hive-Spark开发环境/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/04/13/Mac上搭建Hadoop-Hive-Spark开发环境/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在学习java大数据组件，被hadoop+hive+spark等组件的各种抽象概念搞的云里雾里。文档和书都在读，但如果不去实际运行demo和example，终归记不住，缺乏深刻的印象。</p>
<p>对学习一门新技术新框架，我的经验是第一步看文档，建立初步的概念和印象，第二步跑demo，更直观的看常见的API有哪些，程序是如何调用的，第三步，就是项目中实战运用。最后一步，要精深，需要debug跟进源码。</p>
<p>前段时间基本完成了第一步，对这些大数据组件有了基本的概念，现在准备学习demo，实际运行。网上有很多教程来搭建本地学习环境，但真正动手做起来，才发现还是会遇到各种问题。大家搭建的版本不一样，操作系统环境不一样，遇到的问题也是不一样的。零零碎碎的查官方文档和其他教程，花了将近2天的时间，才真正在Mac系统上搭建起来。</p>
<p>我始终觉得mac做开发，相对windows还是很有优势的，毕竟mac更像linux，配置起来更方便。既然自己也花了这么长时间才搭建好开发环境，就有必要总结和记录一下了。</p>
<p>主要是为了学习spark的examples，由于spark最新版本是2.3.0，依赖的hive是1.2.1版本。而brew安装hadoop和hive的版本依次是3.0.0和2.3.0，运行spark sql时，会出问题。</p>
<p>第一次运行bin/spark-submit –class “org.apache.spark.examples.sql.hive.JavaSparkHiveExample” spark-examples-1.0-SNAPSHOT.jar，会成功在hive中创建src表，但第二次运行时会报错：”org.apache.spark.sql.catalyst.analysis.NoSuchDatabaseException: Database ‘default’ not found;”</p>
<p>用maven dependency:tree来看依赖情况，spark sql依赖的是hive 1.2.1。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[INFO] \- org.apache.spark:spark-hive_2.11:jar:2.3.0:compile</span><br><span class="line">[INFO]    +- com.twitter:parquet-hadoop-bundle:jar:1.6.0:compile</span><br><span class="line">[INFO]    +- org.spark-project.hive:hive-exec:jar:1.2.1.spark2:compile</span><br><span class="line">[INFO]    |  +- commons-io:commons-io:jar:2.4:compile</span><br><span class="line">// ......</span><br><span class="line"></span><br><span class="line">[INFO]    +- org.spark-project.hive:hive-metastore:jar:1.2.1.spark2:compile</span><br><span class="line">[INFO]    |  +- com.jolbox:bonecp:jar:0.8.0.RELEASE:compile</span><br><span class="line">[INFO]    |  +- commons-cli:commons-cli:jar:1.2:compile</span><br><span class="line">[INFO]    |  +- commons-logging:commons-logging:jar:1.1.3:compile</span><br><span class="line">// ......</span><br></pre></td></tr></table></figure></p>
<p>所以手工从官网下载hive 1.2.1版本。从官网更新时间来说，hive 1.2.1 和 2.3.3 是目前主力版本。hive 2相当第一代产品有哪些新功能，后面再研究。</p>
<h3 id="Hadoop-2-6-5-搭建"><a href="#Hadoop-2-6-5-搭建" class="headerlink" title="Hadoop 2.6.5 搭建"></a>Hadoop 2.6.5 搭建</h3><p>1、编辑配置文件<br>etc/hadoop/core-site.xml:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;fs.defaultFS&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;hdfs://localhost:9000&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hadoop.tmp.dir&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;/Users/liaorui/data/hadoop2/hdfs-tmp&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure></p>
<p>注意要配置hadoop.tmp.dir，因为默认hadoop是把数据存在/tmp下的，电脑重启后会丢失。</p>
<p>etc/hadoop/hdfs-site.xml:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;dfs.replication&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;1&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure></p>
<p>etc/hadoop/mapred-site.xml:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;mapreduce.framework.name&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;yarn&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;mapreduce.application.classpath&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;$HADOOP_MAPRED_HOME/share/hadoop/mapreduce/*:$HADOOP_MAPRED_HOME/share/hadoop/mapreduce/lib/*&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure></p>
<p>2、格式化dfs文件系统，并启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ bin/hdfs namenode -format</span><br><span class="line"></span><br><span class="line"># Start NameNode daemon and DataNode daemon:</span><br><span class="line">$ sbin/start-dfs.sh</span><br></pre></td></tr></table></figure></p>
<p>3、建立执行MapReduce任务的HDFS目录。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ bin/hdfs dfs -mkdir /user</span><br><span class="line">$ bin/hdfs dfs -mkdir /user/&lt;username&gt;</span><br></pre></td></tr></table></figure></p>
<p>4、启动yarn<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#Start ResourceManager daemon and NodeManager daemon:</span><br><span class="line">$ sbin/start-yarn.sh</span><br><span class="line"></span><br><span class="line">#Browse the web interface for the ResourceManager; by default it is available at:</span><br><span class="line">    * ResourceManager - http://localhost:8088/</span><br><span class="line"></span><br><span class="line">#When you’re done, stop the daemons with:</span><br><span class="line">$ sbin/stop-yarn.sh</span><br></pre></td></tr></table></figure></p>
<h3 id="Hive-1-2-1搭建"><a href="#Hive-1-2-1搭建" class="headerlink" title="Hive 1.2.1搭建"></a>Hive 1.2.1搭建</h3><p>1、hive配置<br>conf/hive-site.xml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;jdbc:mysql://localhost/metastore&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;the URL of the MySQL database&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionDriverName&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;com.mysql.jdbc.Driver&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionUserName&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;hive&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;hive&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;datanucleus.autoCreateSchema&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;false&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;datanucleus.fixedDatastore&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;datanucleus.autoStartMechanism&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;SchemaTable&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;hive.metastore.uris&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;thrift://localhost:9083&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;IP address (or fully-qualified domain name) and port of the metastore host&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;hive.metastore.schema.verification&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure></p>
<p>2、创建mysql database<br>hive的数据存储在hdfs上，但库表元信息metastore是存储在第三方数据库的。默认是用derby内嵌启动的，但无法多用户访问。所以通常是用mysql或postgresql作为metastore存储。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -u root -p</span><br><span class="line">Enter password:</span><br><span class="line">mysql&gt; CREATE DATABASE metastore;</span><br><span class="line">mysql&gt; USE metastore;</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE USER &apos;hive&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;hive&apos;;</span><br><span class="line">...</span><br><span class="line">mysql&gt; REVOKE ALL PRIVILEGES, GRANT OPTION FROM &apos;hive&apos;@&apos;localhost&apos;;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON metastore.* TO &apos;hive&apos;@&apos;localhost&apos;;</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">mysql&gt; quit;</span><br></pre></td></tr></table></figure>
<p>3、将mysql connector驱动复制到hive/lib目录下，注意用 mysql-connector-java-5.1.22.jar 及以后版本。更早版本可能会报错：<br>com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ‘OPTION SQL_SELECT_LIMIT=DEFAULT’ at line 1</p>
<p>4、设置HADOOP_HOME环境变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#Hive uses Hadoop, so you must have Hadoop in your path OR</span><br><span class="line"></span><br><span class="line">$ export HADOOP_HOME=&lt;hadoop-install-dir&gt;</span><br></pre></td></tr></table></figure></p>
<p>5、在dfs中建立hive需要的目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ $HADOOP_HOME/bin/hadoop fs -mkdir /tmp</span><br><span class="line">$ $HADOOP_HOME/bin/hadoop fs -mkdir /user/hive/warehouse</span><br><span class="line">$ $HADOOP_HOME/bin/hadoop fs -chmod g+w /tmp</span><br><span class="line">$ $HADOOP_HOME/bin/hadoop fs -chmod g+w /user/hive/warehouse</span><br></pre></td></tr></table></figure></p>
<p>6、初始化metastore数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$HIVE_HOME/bin/schematool -dbType mysql -initSchema</span><br></pre></td></tr></table></figure></p>
<p>HiveServer2 (HS2) is a server interface that enables remote clients to execute queries against Hive and retrieve the results (a more detailed intro here). The current implementation, based on Thrift RPC, is an improved version of HiveServer and supports multi-client concurrency and authentication. It is designed to provide better support for open API clients like JDBC and ODBC. </p>
<p>7、运行metastore服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/hive --service metastore</span><br></pre></td></tr></table></figure></p>
<h3 id="Spark-2-3-3搭建"><a href="#Spark-2-3-3搭建" class="headerlink" title="Spark 2.3.3搭建"></a>Spark 2.3.3搭建</h3><p>1、将hadoop的core-site.xml、hdfs-site.xml和hive的hive-site.xml 放在spark的conf下，spark会自动加载hive。</p>
<p>2、将hive-exec-1.2.1.spark2.jar、hive-metastore-1.2.1.spark2.jar、libfb303-0.9.3.jar、libthrift-0.9.3.jar、spark-hive_2.11-2.3.0.jar 放到spark的jars目录。<br>将hive/lib/jline-2.12.jar放到hadoop/share/hadoop/yarn/lib目录，并删除旧版本hive/lib/jline-0.9.jar。</p>
<p>3、将spark/examples目录的demo源码新建maven工程，pom.xml如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.spark&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spark-core_2.11&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.3.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.spark&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spark-sql_2.11&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.3.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.spark&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spark-mllib_2.11&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.3.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.spark&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spark-streaming-kafka-0-10_2.11&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.3.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.github.scopt&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;scopt_2.11&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;3.7.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.spark&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spark-hive_2.11&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.3.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure></p>
<p>将spark examples导入转成maven工程，就方便在idea或eclipse里debug学习了，也方便编译成jar，用spark-submit提交任务。</p>
<p>4、提交spark任务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/spark-submit --class &quot;org.apache.spark.examples.sql.hive.JavaSparkHiveExample&quot; spark-examples-1.0-SNAPSHOT.jar</span><br></pre></td></tr></table></figure></p>
<p>至此，可以运行spark的examples程序了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      

    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/29/Docker构建Python应用镜像/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liao Rui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TechLiving">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/29/Docker构建Python应用镜像/" itemprop="url">Docker构建Python应用镜像</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-29T14:35:51+08:00">
                2018-03-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/29/Docker构建Python应用镜像/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/03/29/Docker构建Python应用镜像/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近需要将Python应用程序部署上线，而用户现场的服务器基于安全原因，是不能访问外网的。Python需要访问Postgresql、Hive和ElasticSearch，需要psycopg2-binary、pyhs2、elasticsearch等插件。在测试环境下，通过pip install就能解决，但纯内网环境下，pip失去了作用。</p>
<p>pyhs2还依赖于cyrus-sasl-devel，有网情况下是通过yum install安装并自动解决rpm包的依赖问题的。另外，nginx、openssl都需要在线内网环境下安装，并且客户机上没有gcc和gcc-c++。</p>
<p>我们一开始是手工下载各类rpm包，然后rpm -ivh手工安装，很快就陷入了万恶的rpm无限依赖。等最后装上这些环境时，相关rpm依赖包达到了50个以上，非常痛苦。</p>
<p>尝试用docker解决这些依赖包问题，期望将Python程序运行需要的rpm和pip插件全部打包成一个镜像，然后在客户机上，直接导入镜像，方便运行。网上关于docker的教程已经很好了，但还是再做一下记录，以备将来之需。</p>
<p>先在测试环境搭一套docker，然后在公共仓库下载一个linux环境。可以根据用户现场的服务器版本，下载对应的linux镜像。我们将在这个镜像的基础上，加入各种依赖文件。这个测试环境，必须是有网的。Docker现在支持Linux, Mac OS, Windows，基于覆盖了常用的各种桌面PC。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull centos:7.2.1511</span><br></pre></td></tr></table></figure></p>
<p>下载完成后，通过 docker images 查看镜像已经在我们本地了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY      TAG             IMAGE ID            CREATED             SIZE</span><br><span class="line">centos          7.2.1511        0a2bad7da9b5        4 months ago        195MB</span><br></pre></td></tr></table></figure></p>
<p>启动CentOS，只需要进入bash环境即可：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8001:8001 -ti &lt;IMAGE ID&gt; /bin/bash</span><br></pre></td></tr></table></figure></p>
<p>IMAGE ID通过docker images查看，只需要输入前4位即可，docker会自动识别。比如上面的IMAGE ID是0a2b。<br>-p参数是将docker的8001端口映射到宿主机的8001端口上，这样就可以在本地机器上通过8001端口直接访问Python程序的接口服务。<br>更多参数通过 docker run –help 来查看。</p>
<p>接下来，    就可以像在物理机一样操作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc</span><br><span class="line">yum -y install gcc-c++</span><br><span class="line">yum -y install python-devel</span><br><span class="line">yum -y install cyrus-sasl-devel</span><br><span class="line"></span><br><span class="line">curl https://bootstrap.pypa.io/get-pip.py | python</span><br><span class="line">pip install flask</span><br><span class="line">pip install pyhs2</span><br><span class="line">pip install psycopg2-binary</span><br><span class="line">pip install elasticsearch</span><br><span class="line">pip install pyyaml</span><br><span class="line">pip install requests</span><br></pre></td></tr></table></figure></p>
<p>装好Python环境后，需要将Python程序复制到镜像里面，新开一个终端，运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp python_app &lt;CONTAINER ID&gt;:/root</span><br></pre></td></tr></table></figure></p>
<p>CONTAINER ID在 docker ps 中看。只需要输入前4位即可，docker会自动识别。</p>
<p>最后，启动Python程序即可。</p>
<p>如果上述步骤都成功了，就可以将当前正在运行的docker容器保存为镜像。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker commit &lt;CONTAINER ID&gt; py_docker</span><br></pre></td></tr></table></figure></p>
<p>再通过 docker images 查看是否存在py_docker。</p>
<p>这个py_docker就是一个完整的Python运行环境，包含了所有的相关依赖。</p>
<p>通过以下命令将镜像导出来：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save py_docker &gt; py_docker</span><br></pre></td></tr></table></figure></p>
<p>现在我们拿到这个镜像文件了，带到客户现场去，直接导入客户机上：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load &lt; py_docker</span><br></pre></td></tr></table></figure></p>
<p>用以下命令来启动：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8001:8001 -ti py_docker</span><br></pre></td></tr></table></figure></p>
<p>通过这些简单的步骤，就解决了在内网环境下，安装Python或其他应用环境所面临的复杂的依赖包。</p>
<p>如果服务器上连docker也没有，就需要先安装docker。其实docker本身通过rpm安装，也是一堆的依赖。下一篇文章将介绍yum离线仓库的构建方法，将docker依赖的rpm全部离线下载，然后拷到客户机上，本地安装。当docker装上后，后面的各种开发环境和应用环境就好解决了，微服务和应用隔离，就可以快乐的实施了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      

    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/23/EnableEurekaServer注解如何启动Eureka-Server/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liao Rui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TechLiving">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/23/EnableEurekaServer注解如何启动Eureka-Server/" itemprop="url">EnableEurekaServer注解如何启动Eureka Server</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-23T17:47:26+08:00">
                2018-03-23
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/23/EnableEurekaServer注解如何启动Eureka-Server/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/03/23/EnableEurekaServer注解如何启动Eureka-Server/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Spring Cloud目前是Java世界里微服务的标准解决方案，它基于Spring Boot，用注解的方式很优雅地将Spring Boot项目加上各种微服务功能，如服务发现，负载均衡，服务熔断等。Spring Cloud包括了Eureka, hystrix, zuul, feign, sleuth, ribbon, turbine等组件。</p>
<p>@EnableEurekaServer魔法一样的将一个普通的Spring Boot应用变成了Eureka的注册中心，如此简单快捷，它是怎么做到的呢？</p>
<p>先看Spring Boot的入口程序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@EnableEurekaServer</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class Application &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		new SpringApplicationBuilder(Application.class).web(true).run(args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>pom.xml引用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-cloud-starter-eureka-server&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
<p>spring-cloud-starter-eureka-server依赖于spring-cloud-netflix-eureka-server，而spring-cloud-netflix-eureka-server又依赖于spring-boot-starter-web。spring-boot-starter-web又会引入tomcat embedded。</p>
<p>web(true)方法会将SpringApplication的webEnvironment置为true，上一篇文章<a href="/2018/03/21/Spring%20Boot如何加载tomcat/">《Spring Boot如何加载tomcat》</a>分析了SpringApplication在检测到web环境后，会自动启动tomcat。</p>
<p>@EnableEurekaServer的实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Import(EurekaServerConfiguration.class)</span><br><span class="line">public @interface EnableEurekaServer &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>用Import注解导入了EurekaServerConfiguration，继续跟踪下去：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@Import(EurekaServerInitializerConfiguration.class)</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">@EnableConfigurationProperties(EurekaDashboardProperties.class)</span><br><span class="line">@PropertySource(&quot;classpath:/eureka/server.properties&quot;)</span><br><span class="line">public class EurekaServerConfiguration extends WebMvcConfigurerAdapter &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>EurekaServerInitializerConfiguration的实现为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public class EurekaServerInitializerConfiguration</span><br><span class="line">		implements ServletContextAware, SmartLifecycle, Ordered &#123;</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private EurekaServerBootstrap eurekaServerBootstrap;</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void start() &#123;</span><br><span class="line">		new Thread(new Runnable() &#123;</span><br><span class="line">			@Override</span><br><span class="line">			public void run() &#123;</span><br><span class="line">				try &#123;</span><br><span class="line">					//TODO: is this class even needed now?</span><br><span class="line">					eurekaServerBootstrap.contextInitialized(EurekaServerInitializerConfiguration.this.servletContext);</span><br><span class="line">					log.info(&quot;Started Eureka Server&quot;);</span><br><span class="line"></span><br><span class="line">					publish(new EurekaRegistryAvailableEvent(getEurekaServerConfig()));</span><br><span class="line">					EurekaServerInitializerConfiguration.this.running = true;</span><br><span class="line">					publish(new EurekaServerStartedEvent(getEurekaServerConfig()));</span><br><span class="line">				&#125;</span><br><span class="line">				catch (Exception ex) &#123;</span><br><span class="line">					// Help!</span><br><span class="line">					log.error(&quot;Could not initialize Eureka servlet context&quot;, ex);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;).start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>EurekaServerInitializerConfiguration实现了SmartLifecycle接口，start()方法会自动被Spring框架调用。eurekaServerBootstrap是通过@Autowired自动导入的，因为EurekaServerConfiguration类里有如下@Bean注解：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public EurekaServerBootstrap eurekaServerBootstrap(PeerAwareInstanceRegistry registry,</span><br><span class="line">		EurekaServerContext serverContext) &#123;</span><br><span class="line">	return new EurekaServerBootstrap(this.applicationInfoManager,</span><br><span class="line">			this.eurekaClientConfig, this.eurekaServerConfig, registry,</span><br><span class="line">			serverContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>得到EurekaServerBootstrap的实例后，就依照EurekaBootstrap的实现，将eureka启动起来。</p>
<p>我们看netflix的eureka的<a href="https://github.com/Netflix/eureka/blob/master/eureka-core/src/main/java/com/netflix/eureka/EurekaBootStrap.java" target="_blank" rel="noopener">EurekaBootstrap</a>代码，它实现了ServletContextListener接口，并且在<a href="https://github.com/Netflix/eureka/blob/master/eureka-server/src/main/webapp/WEB-INF/web.xml" target="_blank" rel="noopener">web.xml</a>中声明了<listener></listener>。因此eureka是作为一个标准的web应用，打包成war包放在tomcat容器里运行的。</p>
<p>而spring-cloud-starter-eureka-server巧妙地将标准的web应用结构转换成Spring Boot项目，并用EurekaServerBootstrap模拟了EurekaBootStrap的行为，二者的代码实现基本是一致的，都对eureka服务进行了配置。但EurekaServerBootstrap并没有实现ServletContextListener接口，更没有在web.xml中声明listener。Spring Boot项目压根就没有web.xml。</p>
<p>以上简要地分析了一个@EnableEurekaServer注解是如何实现eureka服务注册中心的，我们还可以深入学习EurekaServerBootstrap和EurekaBootStrap代码，看看eureka是怎么配置的。官方文档上说eureka的server和client的通讯协议是JSON格式的，通过Jersy和XStream传递，后面继续研究具体的通讯过程。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      

    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/21/Spring Boot如何加载tomcat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liao Rui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TechLiving">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/21/Spring Boot如何加载tomcat/" itemprop="url">Spring Boot如何加载tomcat</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-21T10:05:44+08:00">
                2018-03-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/21/Spring Boot如何加载tomcat/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/03/21/Spring Boot如何加载tomcat/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>有同事说面试时被问到Spring Boot是如何加载tomcat的，我也是一脸懵逼。特意debug了一下，大致的加载过程如下图所示:</p>
<p><img src="/2018/03/21/Spring Boot如何加载tomcat/spring boot load tomcat.png" alt=""></p>
<p>Spring Boot web项目，只需要在pom.xml中引入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.0.1.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
<p>在github上看spring-boot-starter-web的pom.xml定义，有如下依赖：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;2.0.1.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-web&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;2.0.1.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;2.0.1.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
<p>默认加载了tomcat作为web容器。</p>
<p>我们的应用项目启动入口是：SpringApplication.run(Application.class, args)，其中Application.class是包含main()的主类。跟踪到run()方法里面：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public ConfigurableApplicationContext run(String... args) &#123;</span><br><span class="line">		......</span><br><span class="line">		context = createApplicationContext(); //</span><br><span class="line">		......</span><br><span class="line">		refreshContext(context);</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里并没有看到启动tomcat的相关代码。程序的层次结构有些深，大量运用了Java多态特性，基于接口编程，我们看到的都是对接口方法的调用，很难知道具体是哪一个子类实现。</p>
<p>换个思路，从程序运行的log日志里找线索，运行程序，在控制台上找到如下日志：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">2018-03-21 10:55:36.413  INFO 8424 --- [           main] ConfigServletWebServerApplicationContext : Refreshing org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext@77e9807f: startup date [Wed Mar 21 10:55:36 CST 2018]; root of context hierarchy</span><br><span class="line">2018-03-21 10:55:38.847  INFO 8424 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<p>第一次出现tomcat信息的log是在TomcatWebServer类里的initialize()方法，于是逆向溯源，向上查找，找到了TomcatServletWebServerFactory.getTomcatWebServer(Tomcat tomcat)调用，又找到TomcatServletWebServerFactory.getWebServer(ServletContextInitializer… initializers)。</p>
<p>继续向上查找，到了ServletWebServerApplicationContext.createWebServer()方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private void createWebServer() &#123;</span><br><span class="line">		WebServer webServer = this.webServer;</span><br><span class="line">		ServletContext servletContext = getServletContext();</span><br><span class="line">		if (webServer == null &amp;&amp; servletContext == null) &#123;</span><br><span class="line">			ServletWebServerFactory factory = getWebServerFactory(); // factory得到的具体实现是TomcatServletWebServerFactory</span><br><span class="line">			this.webServer = factory.getWebServer(getSelfInitializer());</span><br><span class="line">		&#125;</span><br><span class="line">		else if (servletContext != null) &#123;</span><br><span class="line">			try &#123;</span><br><span class="line">				getSelfInitializer().onStartup(servletContext);</span><br><span class="line">			&#125;</span><br><span class="line">			catch (ServletException ex) &#123;</span><br><span class="line">				throw new ApplicationContextException(&quot;Cannot initialize servlet context&quot;,</span><br><span class="line">						ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		initPropertySources();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>进一步看getWebServerFactory()的实现：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">protected ServletWebServerFactory getWebServerFactory() &#123;</span><br><span class="line">		// Use bean names so that we don&apos;t consider the hierarchy</span><br><span class="line">		String[] beanNames = getBeanFactory()</span><br><span class="line">				.getBeanNamesForType(ServletWebServerFactory.class);  // beanNames数组只有一个元素，且为tomcatServletWebServerFactory</span><br><span class="line">		if (beanNames.length == 0) &#123;</span><br><span class="line">			throw new ApplicationContextException(</span><br><span class="line">					&quot;Unable to start ServletWebServerApplicationContext due to missing &quot;</span><br><span class="line">							+ &quot;ServletWebServerFactory bean.&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		if (beanNames.length &gt; 1) &#123;</span><br><span class="line">			throw new ApplicationContextException(</span><br><span class="line">					&quot;Unable to start ServletWebServerApplicationContext due to multiple &quot;</span><br><span class="line">							+ &quot;ServletWebServerFactory beans : &quot;</span><br><span class="line">							+ StringUtils.arrayToCommaDelimitedString(beanNames));</span><br><span class="line">		&#125;</span><br><span class="line">		return getBeanFactory().getBean(beanNames[0], ServletWebServerFactory.class);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>getBeanFactory().getBeanNamesForType(ServletWebServerFactory.class)用来从classpath中查找具体哪个容器类（tomcat, jetty，netty或undertow），具体怎么实现的呢？</p>
<p>Spring Boot启动类加上@SpringBootApplication或@EnableAutoConfiguration注解后，会导入一个AutoConfigurationImportSelector的类，而这个类会去读取spring-boot-autoconfigure包里spring.factories下key为EnableAutoConfiguration对应的全限定名的值，其中包含了ServletWebServerFactoryAutoConfiguration这个类。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE)</span><br><span class="line">@ConditionalOnClass(ServletRequest.class)</span><br><span class="line">@ConditionalOnWebApplication(type = Type.SERVLET)</span><br><span class="line">@EnableConfigurationProperties(ServerProperties.class)</span><br><span class="line">@Import(&#123; ServletWebServerFactoryAutoConfiguration.BeanPostProcessorsRegistrar.class,</span><br><span class="line">		ServletWebServerFactoryConfiguration.EmbeddedTomcat.class,</span><br><span class="line">		ServletWebServerFactoryConfiguration.EmbeddedJetty.class,</span><br><span class="line">		ServletWebServerFactoryConfiguration.EmbeddedUndertow.class &#125;)</span><br><span class="line">public class ServletWebServerFactoryAutoConfiguration &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>又通过@Import注解引用了ServletWebServerFactoryConfiguration类。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">class ServletWebServerFactoryConfiguration &#123;</span><br><span class="line"></span><br><span class="line">	@Configuration</span><br><span class="line">	@ConditionalOnClass(&#123; Servlet.class, Tomcat.class, UpgradeProtocol.class &#125;)</span><br><span class="line">	@ConditionalOnMissingBean(value = ServletWebServerFactory.class, search = SearchStrategy.CURRENT)</span><br><span class="line">	public static class EmbeddedTomcat &#123;</span><br><span class="line">		@Bean</span><br><span class="line">		public TomcatServletWebServerFactory tomcatServletWebServerFactory() &#123;</span><br><span class="line">			return new TomcatServletWebServerFactory();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * Nested configuration if Jetty is being used.</span><br><span class="line">	 */</span><br><span class="line">	@Configuration</span><br><span class="line">	@ConditionalOnClass(&#123; Servlet.class, Server.class, Loader.class,</span><br><span class="line">			WebAppContext.class &#125;)</span><br><span class="line">	@ConditionalOnMissingBean(value = ServletWebServerFactory.class, search = SearchStrategy.CURRENT)</span><br><span class="line">	public static class EmbeddedJetty &#123;</span><br><span class="line">		@Bean</span><br><span class="line">		public JettyServletWebServerFactory JettyServletWebServerFactory() &#123;</span><br><span class="line">			return new JettyServletWebServerFactory();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * Nested configuration if Undertow is being used.</span><br><span class="line">	 */</span><br><span class="line">	@Configuration</span><br><span class="line">	@ConditionalOnClass(&#123; Servlet.class, Undertow.class, SslClientAuthMode.class &#125;)</span><br><span class="line">	@ConditionalOnMissingBean(value = ServletWebServerFactory.class, search = SearchStrategy.CURRENT)</span><br><span class="line">	public static class EmbeddedUndertow &#123;</span><br><span class="line">		@Bean</span><br><span class="line">		public UndertowServletWebServerFactory undertowServletWebServerFactory() &#123;</span><br><span class="line">			return new UndertowServletWebServerFactory();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过@ConditionalOnClass和@ConditionalOnMissingBean注解，在classpath中寻找tomcat或jetty或undertow的jar包。</p>
<p>spring-boot-starter-web默认加载了spring-boot-starter-tomcat，进而加载了tomcat-embed-core，所以这里得到了tomcatServletWebServerFactory，并通过getTomcatWebServer(Tomcat tomcat)实例化TomcatWebServer，最终TomcatWebServer调用initialize()方法完成tomcat.start()调用。</p>
<p>读取spring.factories文件的实现是通过org.springframework.core.io.support.SpringFactoriesLoader实现。SpringFactoriesLoader的实现类似于SPI（Service Provider Interface，在java.util.ServiceLoader的文档里有比较详细的介绍。java SPI提供一种服务发现机制，为某个接口寻找服务实现的机制。SpringFactoriesLoader会加载classpath下所有JAR文件里面的META-INF/spring.factories文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">AutoConfigurationImportSelector.java</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">	 * Return the auto-configuration class names that should be considered. By default</span><br><span class="line">	 * this method will load candidates using &#123;@link SpringFactoriesLoader&#125; with</span><br><span class="line">	 * &#123;@link #getSpringFactoriesLoaderFactoryClass()&#125;.</span><br><span class="line">	 * @param metadata the source metadata</span><br><span class="line">	 * @param attributes the &#123;@link #getAttributes(AnnotationMetadata) annotation</span><br><span class="line">	 * attributes&#125;</span><br><span class="line">	 * @return a list of candidate configurations</span><br><span class="line">	 */</span><br><span class="line">	protected List&lt;String&gt; getCandidateConfigurations(AnnotationMetadata metadata,</span><br><span class="line">			AnnotationAttributes attributes) &#123;</span><br><span class="line">		List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(</span><br><span class="line">				getSpringFactoriesLoaderFactoryClass(), getBeanClassLoader());</span><br><span class="line">		Assert.notEmpty(configurations,</span><br><span class="line">				&quot;No auto configuration classes found in META-INF/spring.factories. If you &quot;</span><br><span class="line">						+ &quot;are using a custom packaging, make sure that file is correct.&quot;);</span><br><span class="line">		return configurations;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">SpringFactoriesLoader.java</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">	 * Load the fully qualified class names of factory implementations of the</span><br><span class="line">	 * given type from &#123;@value #FACTORIES_RESOURCE_LOCATION&#125;, using the given</span><br><span class="line">	 * class loader.</span><br><span class="line">	 * @param factoryClass the interface or abstract class representing the factory</span><br><span class="line">	 * @param classLoader the ClassLoader to use for loading resources; can be</span><br><span class="line">	 * &#123;@code null&#125; to use the default</span><br><span class="line">	 * @see #loadFactories</span><br><span class="line">	 * @throws IllegalArgumentException if an error occurs while loading factory names</span><br><span class="line">	 */</span><br><span class="line">	public static List&lt;String&gt; loadFactoryNames(Class&lt;?&gt; factoryClass, @Nullable ClassLoader classLoader) &#123;</span><br><span class="line">		String factoryClassName = factoryClass.getName();</span><br><span class="line">		return loadSpringFactories(classLoader).getOrDefault(factoryClassName, Collections.emptyList());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private static Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(@Nullable ClassLoader classLoader) &#123;</span><br><span class="line">		MultiValueMap&lt;String, String&gt; result = cache.get(classLoader);</span><br><span class="line">		if (result != null) &#123;</span><br><span class="line">			return result;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		try &#123;</span><br><span class="line">			Enumeration&lt;URL&gt; urls = (classLoader != null ?</span><br><span class="line">					classLoader.getResources(FACTORIES_RESOURCE_LOCATION) :</span><br><span class="line">					ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));</span><br><span class="line">			result = new LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">			while (urls.hasMoreElements()) &#123;</span><br><span class="line">				URL url = urls.nextElement();</span><br><span class="line">				UrlResource resource = new UrlResource(url);</span><br><span class="line">				Properties properties = PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">				for (Map.Entry&lt;?, ?&gt; entry : properties.entrySet()) &#123;</span><br><span class="line">					List&lt;String&gt; factoryClassNames = Arrays.asList(</span><br><span class="line">							StringUtils.commaDelimitedListToStringArray((String) entry.getValue()));</span><br><span class="line">					result.addAll((String) entry.getKey(), factoryClassNames);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			cache.put(classLoader, result);</span><br><span class="line">			return result;</span><br><span class="line">		&#125;</span><br><span class="line">		catch (IOException ex) &#123;</span><br><span class="line">			throw new IllegalArgumentException(&quot;Unable to load factories from location [&quot; +</span><br><span class="line">					FACTORIES_RESOURCE_LOCATION + &quot;]&quot;, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>JettyServletWebServerFactory和UndertowServletWebServerFactory，也继承了AbstractServletWebServerFactory，为何它们没有被getBeanNamesForType(ServletWebServerFactory.class)获取到呢? 查看他们的源码，可以看到分别import了org.eclipse.jetty.*和io.undertow.*，但我们并没有在项目中引入jetty或undertow，所以JettyServletWebServerFactory和UndertowServletWebServerFactory是没办法通过getBeanFactory().getBean(name, ServletWebServerFactory.class)来实例化的。</p>
<p><img src="/2018/03/21/Spring Boot如何加载tomcat/servletwebserverfactory.png" alt=""></p>
<p>如果pom.xml中同时加了tomcat和jetty，beanNames会得到两个元素，元素个数超过1，也会报错：“Unable to start ServletWebServerApplicationContext due to multiple ServletWebServerFactory beans”。</p>
<p>另外一个问题是，Spring Boot是怎么判断是否是一个web应用，并自动加载对应的web容器的？这是由SpringApplication的webEnvironment变量来标识的。</p>
<p>当工程的pom.xml文件里引入了spring-boot-starter-web，SpringApplication.run()方法会调用new SpringApplication(sources).run(args)，然后在void initialize(Object[] sources)方法里对webEnvironment赋值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">this.webEnvironment = deduceWebEnvironment();</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">private boolean deduceWebEnvironment() &#123;</span><br><span class="line">	for (String className : WEB_ENVIRONMENT_CLASSES) &#123;</span><br><span class="line">		if (!ClassUtils.isPresent(className, null)) &#123;</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">private static final String[] WEB_ENVIRONMENT_CLASSES = &#123; &quot;javax.servlet.Servlet&quot;,</span><br><span class="line">&quot;org.springframework.web.context.ConfigurableWebApplicationContext&quot; &#125;;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">private ConfigurableEnvironment getOrCreateEnvironment() &#123;</span><br><span class="line">		if (this.environment != null) &#123;</span><br><span class="line">			return this.environment;</span><br><span class="line">		&#125;</span><br><span class="line">		if (this.webEnvironment) &#123;</span><br><span class="line">			return new StandardServletEnvironment();</span><br><span class="line">		&#125;</span><br><span class="line">		return new StandardEnvironment();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>从以上代码里可以看到，通过反射技术判断Java环境变量里是否有Servlet和ConfigurableWebApplicationContext,如果都找到了，webEnvironment置为ture，并在后面创建StandardServletEnvironment的配置环境，最后启动web容器。</p>
<p>注意以上是基于spring boot 2.0版本的分析，而1.5的版本，是用EmbeddedWebApplicationContext和TomcatEmbeddedServletContainerFactory来实现的。</p>
<p>spring-boot-starter总共提供了51个常用的库加载，很方便的简化了第三方库的引用和配置，都值得我们应用和学习。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      

    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/14/飞机经纬度连线消除锯齿/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liao Rui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TechLiving">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/14/飞机经纬度连线消除锯齿/" itemprop="url">飞机经纬度连线消除锯齿</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-14T20:30:45+08:00">
                2018-03-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/14/飞机经纬度连线消除锯齿/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/03/14/飞机经纬度连线消除锯齿/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在<a href="https://liaorui.github.io/2018/02/02/ADS-B%E7%AE%80%E4%BB%8B/" target="_blank" rel="noopener">ADS-B简介</a>这篇文章里，介绍了ADS-B的数据样式。利用ADS-B的数据，我们可以做出类似<a href="https://www.flightradar24.com" target="_blank" rel="noopener">Flightradar24</a>这样酷炫的飞机轨迹图，只要把一系统连续点的经、纬度在地图上连线即可。</p>
<p>像Flightradar24这样的专业ADS-B数据商，都会有多种ADS-B数据源。拿到几个接收器或几个数据源的数据后，需要进行整合。如果仅仅按获取到的实时位置的创建时间来整合，则在地图上画出来的曲线会存在锯齿。原因是各个ADS-B接收器的规格、参数、网络的差异，对同一区域的同一架飞机的监控，各个设备获取到的经纬度数据也可能存在误差。</p>
<p>这里利用Thaddeus Vincenty的地理空间经纬度算法，消除明显的棱角，得到比较顺滑的曲线。Java代码实现在这里：<a><a href="https://github.com/mgavaghan/geodesy" target="_blank" rel="noopener">https://github.com/mgavaghan/geodesy</a></a></p>
<p>思路是，根据上一个位置的<b>经纬度、速度、航向、飞行时间</b>（上一个时间距离当前的时间的时长），推算出下一个飞行到达的位置（理论位置），并跟当前位置（从ADS-B数据源拿到的位置）进行比较。如果在一个合理的误差范围，则认为数据源提供的当前位置有效，否则认为数据源给的当前位置无效，会出现锯齿，应丢弃。</p>
<p>关键代码为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if (lastRB24Log != null) &#123;</span><br><span class="line">    int seconds = DateTimeUtil.getDateDiffSecond(planeLog.getCreateTime(), lastRB24Log.getCreateTime());</span><br><span class="line">    double flyLen = GpsGeometryCalculate.getMetricLenght(lastRB24Log.getSpeed(), seconds);</span><br><span class="line">    double[] calPoint = GpsGeometryCalculate.calEndPointGps(lastRB24Log.getLatitude(), lastRB24Log.getLongitude(), flyLen, lastRB24Log.getCourse());</span><br><span class="line">    double latDelta = Math.abs(calPoint[0] - planeLog.getLatitude());</span><br><span class="line">    double lonDelta = Math.abs(calPoint[1] - planeLog.getLongitude());</span><br><span class="line">    if (seconds &lt; 120 &amp;&amp; (latDelta &gt; 0.1 &amp;&amp; latDelta &lt; 1) || (lonDelta &gt; 0.1 &amp;&amp; lonDelta &lt; 1)) &#123;</span><br><span class="line">        // 2分钟内，纬度或经度跨度太大，不合理，需要丢弃</span><br><span class="line">        continue;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        lastRB24Log = planeLog;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中getMetricLenght()和calEndPointGps()方法实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// 速度转换常数 1kn(节） =1.852km/小时</span><br><span class="line">private static double KN_TO_KM = 1.852;</span><br><span class="line"></span><br><span class="line">public static double getMetricLenght(int kn, int runTime) &#123;</span><br><span class="line">    return kn * KN_TO_KM * runTime / 3600;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static double[] calEndPointGps(Double lastLat, Double lastLng, double flyingLenght, double azimuth) &#123;</span><br><span class="line">    GeodeticCalculator geoCalc = new GeodeticCalculator();</span><br><span class="line"></span><br><span class="line">    // select a reference elllipsoid</span><br><span class="line">    Ellipsoid reference = Ellipsoid.WGS84;</span><br><span class="line"></span><br><span class="line">    // set Lincoln Memorial coordinates</span><br><span class="line">    GlobalCoordinates lincolnMemorial;</span><br><span class="line">    lincolnMemorial = new GlobalCoordinates(lastLat, lastLng);</span><br><span class="line"></span><br><span class="line">    // set the direction and distance</span><br><span class="line">    double startBearing = azimuth;</span><br><span class="line">    double distance = flyingLenght * 1000;</span><br><span class="line"></span><br><span class="line">    // find the destination</span><br><span class="line">    double[] endBearing = new double[1];</span><br><span class="line">    GlobalCoordinates dest = geoCalc.calculateEndingGlobalCoordinates(reference, lincolnMemorial, startBearing,</span><br><span class="line">            distance, endBearing);</span><br><span class="line">    return new double[] &#123; dest.getLatitude(), dest.getLongitude() &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的120秒，纬度或经度跨度大于0.1，是经验值，需要根据大量测试数据对比得到。</p>
<p>如果飞机在空中转弯或画圈，飞行轨迹为弧线，如果ADS-B信号不好，拿到的位置点不连续，也会导致地图上画的线成了折线，不够圆滑。于是想到用<a href="http://www.cnblogs.com/hnfxs/p/3148483.html" target="_blank" rel="noopener">贝塞尔曲线</a>算法，来拟合曲线上的点，让画出来的曲线看起来更圆滑。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">double geolat1 = 36.5467;</span><br><span class="line">double geolon1 = 101.7883;</span><br><span class="line">    </span><br><span class="line">double geolat2 = 36.5044;</span><br><span class="line">double geolon2 = 101.8472;</span><br><span class="line"></span><br><span class="line">// 控制点</span><br><span class="line">double contrlat = 36.5250;</span><br><span class="line">double contrlon = 101.8175;</span><br><span class="line"></span><br><span class="line">// 贝塞尔曲线</span><br><span class="line">for (float t = 0.1f; t &lt; 1; t += 0.2) &#123;</span><br><span class="line">    double x = (1 - t) * (1 - t) * geolat1 + 2 * (1 - t) * t * contrlat + t * t * geolat2;</span><br><span class="line">    double y = (1 - t) * (1 - t) * geolon1 + 2 * (1 - t) * t * geolon2 + t * t * contrlon;</span><br><span class="line">    System.out.println(x + &quot;, &quot; + y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>假定只拿到弧线上的两个点(36.5467,101.7883),(36.5044,101.8472)，选择一个控制点(36.5250,101.8175)，控制变量t从0到1的变换中，拟合出很多点，这些点组成的曲线看起来有很好的弧形。</p>
<p>而实际上，控制点很难选择和确定，后续项目中再慢慢研究吧。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      

    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/09/最长上升子序列LIS判断飞机高度的变化趋势/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liao Rui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TechLiving">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/09/最长上升子序列LIS判断飞机高度的变化趋势/" itemprop="url">最长上升子序列LIS判断飞机高度的变化趋势</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-09T13:33:31+08:00">
                2018-03-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/09/最长上升子序列LIS判断飞机高度的变化趋势/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/03/09/最长上升子序列LIS判断飞机高度的变化趋势/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>LIS（Longest Increasing Subsequence）定义: 给出一个序列a1,a2,a3,a4,a5,a6,a7….an,求它的一个子序列（设为s1,s2,…sn），使得这个子序列满足这样的性质，s1 &lt; s2 &lt; s3 &lt; … &lt; sn并且这个子序列的长度最长，输出这个最长的长度。<br>例如有一个序列:1  7  3  5  9  4  8，它的最长上升子序列就是1 3 4 8，长度为4。</p>
<p>有两种时间复杂度分别为O(N^2)和O(NlogN)的算法，关于这两种算法的描述，网上都有很多资料，这里不再赘述。对于O(NlogN)的算法，利用贪心的思想，对于一个上升子序列，显然当最后一个元素越小，越有利于添加新的元素，这样LIS长度自然更长。 </p>
<p>直接给出代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public static int[] longestIncreasingSubsequence(int[] arr) &#123;</span><br><span class="line">        int i, n = arr.length, top, temp;</span><br><span class="line">        int[] stack = new int[n + 1];</span><br><span class="line">        int[] idxes = new int[n];</span><br><span class="line">        top = 0;</span><br><span class="line">        int idx = 0;// 记录LIS序列中元素对应的arr下标，便于修正LIS中下标错位的元素</span><br><span class="line">        </span><br><span class="line">        /* 为了方便top始终指向栈顶，stack从下标1开始使用，stack[0]设置为-1不使用 */</span><br><span class="line">        stack[0] = -1;</span><br><span class="line">        </span><br><span class="line">        // -----------------------------------------------------</span><br><span class="line">        // 一个for循环加一个二分查找，算法时间复杂度是o(NlogN)</span><br><span class="line">        // -----------------------------------------------------</span><br><span class="line">        for (i = 0; i &lt; n; i++) &#123;</span><br><span class="line">            temp = arr[i];</span><br><span class="line">            /* 比栈顶元素大数就入栈 */</span><br><span class="line">            if (temp &gt; stack[top]) &#123;</span><br><span class="line">                stack[++top] = temp;</span><br><span class="line">                idxes[idx++] = i;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                int low = 1, high = top;</span><br><span class="line">                int mid;</span><br><span class="line">                /* 二分检索栈中比temp大的第一个数 */</span><br><span class="line">                while (low &lt;= high) &#123;</span><br><span class="line">                    mid = (low + high) / 2;</span><br><span class="line">                    if (temp &gt; stack[mid]) &#123;</span><br><span class="line">                        low = mid + 1;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        high = mid - 1;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                /* 用temp替换 */</span><br><span class="line">                stack[low] = temp;</span><br><span class="line">                idxes[low - 1] = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // -----------------------------------------------------</span><br><span class="line">        print(idxes);</span><br><span class="line">        int[] lis = Arrays.copyOfRange(stack, 1, top + 1);</span><br><span class="line">        print(lis); // 得到递增的最长子序列，但不一定是原数组的最长上升子序列</span><br><span class="line"></span><br><span class="line">        return lis;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>给定输入数组：2000 3325 2050 1990 1980 3335 7800 4025 4575 5625 6900 6800<br>得到的LIS为：1980 2050 3335 4025 4575 5625 6800<br>LIS在原数组的位置idxes为：4 2 5 7 8 9 11</p>
<p>可以看到LIS的第1个元素是1980，这个并不是源数据的最长上升子序列，因为顺序不对。但LIS的长度为7，却是正确的最长子序列的最大长度。</p>
<p>网上的各个博客到这里就结束了，只是算出来LIS的最大长度，并没有真正给出LIS。</p>
<p>针对上面出现的可能出现顺序错误的情况，需要进行修正。修正算法如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// -----------------------------------------------------</span><br><span class="line">// 这里开始修正lis中顺序错乱的元素</span><br><span class="line">// -----------------------------------------------------</span><br><span class="line">for (int k = lis.length - 1; k &gt;= 1; k--) &#123;</span><br><span class="line">    if (idxes[k] &lt; idxes[k - 1]) &#123; // 下标错乱，需要修正</span><br><span class="line">        int max = 0;</span><br><span class="line">        int newIndex = 0;</span><br><span class="line">        for (int m = 0; m &lt; idxes[k]; m++) &#123; // 从lis[0..k-1]找出小于lis[k]的最大数</span><br><span class="line">            if (max &lt; arr[m] &amp;&amp; arr[m] &lt; lis[k]) &#123;</span><br><span class="line">                max = arr[m];</span><br><span class="line">                newIndex = m;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        idxes[k - 1] = newIndex;</span><br><span class="line">        lis[k - 1] = max;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>经过修正后的lis为：2000 2050 3335 4025 4575 5625 6800。第1个元素1980被替换成2000，这个就是正确的LIS了。</p>
<p>LIS算法在判断飞机高度变化趋势时很有用。地面的ADS-B接收器不断接收飞机的ADS-B广播，拿到一系列的经纬度和高度。怎么知道飞机刚从出发地起飞，还是准备降落目的地呢？</p>
<p>正常情况下，飞机刚起飞，高度不断增加，我们拿到高度序列后，直接判断最后一个高度大于第一个高度，就可以认为是起飞状态。但现在生活中，飞机因为大气气流的影响，起飞后为躲避气流，会来间断的下降后又上升，所以高度序列并不是连续递增的，例如：2000, 3125, 3325, 2000, 3325, 4025, 4575, 5625, 6900, 7925, 7950, 7925, 7700, 7275, 7050, 6925, 6500, 6350, 5400, 4825, 3150, 2250。</p>
<p>利用LIS算法，可以知道最大上升子序列为：2000 3125 3325 4025 4575 5625 6900 7925 7950，<br>高度序列逆序后再用LIS算法计算，得到最大下降子序列为：7950 7925 7700 7275 7050 6925 6500 6350 5400 4825 3150 2250。因此可以判定飞机是处于下降的趋势，而直接根据首尾判断却是上升趋势。</p>
<p>实际应用中，为了减少误判，高度序列要尽可能长些，多一些数据才能更准确反映出变化趋势。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      

    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/04/Play-Framework-Anorm返回class对象/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liao Rui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TechLiving">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/04/Play-Framework-Anorm返回class对象/" itemprop="url">Play Framework Anorm返回class对象</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-04T17:42:08+08:00">
                2018-03-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/04/Play-Framework-Anorm返回class对象/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/03/04/Play-Framework-Anorm返回class对象/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Scala是构建在JVM上的函数式编程语言，在大数据领域开始展现出独特的优势，Kafka，Spark，Flink组件等都是用Scala开发的。而在web开发领域，<a href="https://github.com/playframework/playframework" target="_blank" rel="noopener">Play Framework</a>是最优秀的Scala响应式编程web框架。</p>
<p>Play Framework支持Slick和Anorm两种方式操作数据库。Slick支持Functional Relational Mapping (FRM)的访问方式，类似于Java平台的ORM。Anorm相对Slick更简单，直接用SQL语句交互，并提供了结果集的类型转换。</p>
<p>Anorm如何将查询结果转换成Scala case class对象，<a href="https://www.playframework.com/documentation/2.6.x/ScalaAnorm#Generated-parsers" target="_blank" rel="noopener">官方文档</a>介绍的不是很详细，用了Macro.namedParser，宏定义导致语法错误没办法被IDE编译阶段发现，给开发调度带来不便。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">val parser: RowParser[Info] = Macro.parser[Info](&quot;a_name&quot;, &quot;creation&quot;)</span><br><span class="line">/* Generated as:</span><br><span class="line">get[String](&quot;a_name&quot;) ~ get[Option[Int]](&quot;creation&quot;) map &#123;</span><br><span class="line">  case name ~ year =&gt; Info(name, year)</span><br><span class="line">&#125;</span><br><span class="line">*/</span><br></pre></td></tr></table></figure></p>
<p>其实可以直接去掉Macro.parser，用以下语法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val parser: RowParser[Info] = get[String](&quot;a_name&quot;) ~ get[Option[Int]](&quot;creation&quot;) map &#123;</span><br><span class="line">  case name ~ year =&gt; Info(name, year)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样也方便在map里对name和year做数据转换，例如对year进行日期格式化或加减天数，而在上面的宏定义语法里是没办法支持的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      

    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/25/Spring-Boot项目maven打包方式总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liao Rui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TechLiving">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/25/Spring-Boot项目maven打包方式总结/" itemprop="url">Spring Boot项目maven打包方式总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-25T08:49:55+08:00">
                2018-02-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/25/Spring-Boot项目maven打包方式总结/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/02/25/Spring-Boot项目maven打包方式总结/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Spring Boot将Spring框架和第三方依赖jar包集成在一起，开发者只需要很少的配置就可以实现”just run”的目标。</p>
<p>Spring Boot为maven管理的项目提供了spring-boot-maven-plugin插件，自动打包各种依赖包，生成一个java -jar直接运行的单独的jar包。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.4.2.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure></p>
<p>这种打包方式适合于服务器端打包，可以避免各种配置错误和依赖包缺少及冲突，常用Jenkins+git+maven来做持续集成发布。</p>
<p>而在某些场景下，想直接在本地打包，再上传到服务器运行，由于jar包通常都是50M以上，需要花费较长的网络传输时间。特别是网络情况不好时，经常上传失败，严重影响工作效率。</p>
<p>可以用如下maven插件配置，将业务代码和依赖lib库分离，lib目录下的各个依赖包一次上传服务器，后续只需要上传业务代码jar包就行了，不需要每次重复上传依赖包。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">        &lt;encoding&gt;UTF-8&lt;/encoding&gt;</span><br><span class="line">        &lt;archive&gt;</span><br><span class="line">            &lt;manifest&gt;</span><br><span class="line">                &lt;mainClass&gt;com.xxx.Application&lt;/mainClass&gt;</span><br><span class="line">                &lt;addClasspath&gt;true&lt;/addClasspath&gt;</span><br><span class="line">                &lt;classpathPrefix&gt;lib/&lt;/classpathPrefix&gt;</span><br><span class="line">            &lt;/manifest&gt;</span><br><span class="line">        &lt;/archive&gt;</span><br><span class="line">    &lt;/configuration&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;executions&gt;</span><br><span class="line">        &lt;execution&gt;</span><br><span class="line">            &lt;id&gt;copy-dependencies&lt;/id&gt;</span><br><span class="line">            &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">                &lt;goal&gt;copy-dependencies&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;outputDirectory&gt;$&#123;project.build.directory&#125;/lib&lt;/outputDirectory&gt;</span><br><span class="line">                &lt;overWriteReleases&gt;false&lt;/overWriteReleases&gt;</span><br><span class="line">                &lt;overWriteSnapshots&gt;false&lt;/overWriteSnapshots&gt;</span><br><span class="line">                &lt;overWriteIfNewer&gt;true&lt;/overWriteIfNewer&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">        &lt;/execution&gt;</span><br><span class="line">    &lt;/executions&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure></p>
<p>原理是将各种依赖jar包全部放在lib目录下，然后在业务项目jar包里的META-INF/MANIFEST.MF里自动添加Class-Path路径。用java -jar运行时，可以自动去lib目录下加载依赖jar包。</p>
<p>项目开发时，通常会有本地环境，测试环境和线上环境，每个环境的配置文件是不一样的。有如下两种解决方法。</p>
<p>1、在src/main/resources下生成dev、test、production三个目录，分别放入各自配置文件，然后利用profile和resource属性指定。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;profiles&gt;</span><br><span class="line">    &lt;profile&gt;</span><br><span class="line">        &lt;id&gt;production&lt;/id&gt;</span><br><span class="line">        &lt;activation&gt;</span><br><span class="line">            &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;</span><br><span class="line">        &lt;/activation&gt;</span><br><span class="line">        &lt;properties&gt;</span><br><span class="line">            &lt;env&gt;production&lt;/env&gt;</span><br><span class="line">        &lt;/properties&gt;</span><br><span class="line">    &lt;/profile&gt;</span><br><span class="line">    &lt;profile&gt;</span><br><span class="line">        &lt;id&gt;test&lt;/id&gt;</span><br><span class="line">        &lt;properties&gt;</span><br><span class="line">            &lt;env&gt;test&lt;/env&gt;</span><br><span class="line">        &lt;/properties&gt;</span><br><span class="line">    &lt;/profile&gt;</span><br><span class="line">    &lt;profile&gt;</span><br><span class="line">        &lt;id&gt;dev&lt;/id&gt;</span><br><span class="line">        &lt;properties&gt;</span><br><span class="line">            &lt;env&gt;dev&lt;/env&gt;</span><br><span class="line">        &lt;/properties&gt;</span><br><span class="line">    &lt;/profile&gt;</span><br><span class="line">&lt;/profiles&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;resources&gt;</span><br><span class="line">    &lt;resource&gt;</span><br><span class="line">        &lt;directory&gt;src/main/resources/$&#123;env&#125;&lt;/directory&gt;</span><br><span class="line">        &lt;includes&gt;</span><br><span class="line">            &lt;include&gt;**/*.properties&lt;/include&gt;</span><br><span class="line">            &lt;include&gt;**/*.xml&lt;/include&gt;</span><br><span class="line">        &lt;/includes&gt;</span><br><span class="line">    &lt;/resource&gt;</span><br><span class="line">    &lt;resource&gt;</span><br><span class="line">        &lt;directory&gt;src/main/resources&lt;/directory&gt;</span><br><span class="line">        &lt;includes&gt;</span><br><span class="line">            &lt;include&gt;**/*.xml&lt;/include&gt;</span><br><span class="line">            &lt;include&gt;**/*.properties&lt;/include&gt;</span><br><span class="line">        &lt;/includes&gt;</span><br><span class="line">        &lt;excludes&gt;</span><br><span class="line">            &lt;exclude&gt;src/main/resources/META-INF&lt;/exclude&gt;</span><br><span class="line">        &lt;/excludes&gt;</span><br><span class="line">    &lt;/resource&gt;</span><br><span class="line">&lt;/resources&gt;</span><br></pre></td></tr></table></figure>
<p>配置好后，通过maven的-P参数：mvn package -Pdev、mvn package -Ptest和mvn package -Pproduction，打包不同环境的配置文件。如果不指定-P，则默认是production环境。</p>
<p>2、配置文件里用${}占位符，利用maven-resources-plugin自动填充。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">application.properties配置：</span><br><span class="line">server.port=$&#123;server.port&#125;</span><br><span class="line"></span><br><span class="line">pom.xml配置：</span><br><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">        &lt;encoding&gt;UTF-8&lt;/encoding&gt;</span><br><span class="line">        &lt;delimiters&gt;</span><br><span class="line">            &lt;delimiter&gt;$&#123;*&#125;&lt;/delimiter&gt;</span><br><span class="line">        &lt;/delimiters&gt;</span><br><span class="line">        &lt;resources&gt;</span><br><span class="line">            &lt;resource&gt;</span><br><span class="line">                &lt;directory&gt;src/main/resources&lt;/directory&gt;</span><br><span class="line">                &lt;filtering&gt;true&lt;/filtering&gt;</span><br><span class="line">                &lt;includes&gt;</span><br><span class="line">                    &lt;include&gt;*.properties&lt;/include&gt;</span><br><span class="line">                    &lt;include&gt;*.xml&lt;/include&gt;</span><br><span class="line">                &lt;/includes&gt;</span><br><span class="line">            &lt;/resource&gt;</span><br><span class="line">        &lt;/resources&gt;</span><br><span class="line">    &lt;/configuration&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">&lt;profiles&gt;</span><br><span class="line">    &lt;profile&gt;</span><br><span class="line">        &lt;id&gt;production&lt;/id&gt;</span><br><span class="line">        &lt;activation&gt;</span><br><span class="line">            &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;</span><br><span class="line">        &lt;/activation&gt;</span><br><span class="line">        &lt;properties&gt;</span><br><span class="line">            &lt;server.port&gt;8080&lt;/server.port&gt;</span><br><span class="line">        &lt;/properties&gt;</span><br><span class="line">    &lt;/profile&gt;</span><br><span class="line">    &lt;profile&gt;</span><br><span class="line">        &lt;id&gt;test&lt;/id&gt;</span><br><span class="line">        &lt;properties&gt;</span><br><span class="line">            &lt;server.port&gt;6680&lt;/server.port&gt;</span><br><span class="line">        &lt;/properties&gt;</span><br><span class="line">    &lt;/profile&gt;</span><br><span class="line">    &lt;profile&gt;</span><br><span class="line">        &lt;id&gt;dev&lt;/id&gt;</span><br><span class="line">        &lt;properties&gt;</span><br><span class="line">            &lt;server.port&gt;6688&lt;/server.port&gt;</span><br><span class="line">        &lt;/properties&gt;</span><br><span class="line">    &lt;/profile&gt;</span><br><span class="line">&lt;/profiles&gt;</span><br></pre></td></tr></table></figure></p>
<p>同样运行maven命令打包：mvn package -Pdev或-Ptest或-Pproduction即可。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      

    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/12/Dump1090设备标识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liao Rui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TechLiving">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/12/Dump1090设备标识/" itemprop="url">Dump1090设备标识</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-12T08:44:20+08:00">
                2018-02-12
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/12/Dump1090设备标识/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/02/12/Dump1090设备标识/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇文章介绍了ADS-B基本概念和如何自己搭建ADS-B receiver。ADS-B receiver的主机通常会自带一个嵌入式操作系统，刷入<a href="https://github.com/MalcolmRobb/dump1090" target="_blank" rel="noopener">dump1090</a>程序。如果设备天线和USB转换连接都没问题，在主机上执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./dump1090 --interactive --net --aggressive</span><br></pre></td></tr></table></figure></p>
<p>就可以启动dum1090服务了。dump10990自带了一个http服务，可以导出捕获的飞机广播信号：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8080/dump1090/data.json</span><br></pre></td></tr></table></figure></p>
<p>如果设备运行正常，可以看到如下数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;hex&quot;:&quot;780e0d&quot;, &quot;squawk&quot;:&quot;0000&quot;, &quot;flight&quot;:&quot;&quot;, &quot;lat&quot;:25.137696, &quot;lon&quot;:114.456188, &quot;validposition&quot;:1, &quot;altitude&quot;:21700,  &quot;vert_rate&quot;:0,&quot;track&quot;:205, &quot;validtrack&quot;:1,&quot;speed&quot;:395, &quot;messages&quot;:13, &quot;seen&quot;:1,&quot;validground&quot;:0&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果有多台ADS-B receiver，还可以组成一个网络，把各个receiver的数据汇集在一起，集中处理和展示。原理看这里：<br><a><a href="https://github.com/antirez/dump1090#network-server-features" target="_blank" rel="noopener">https://github.com/antirez/dump1090#network-server-features</a></a></p>
<p>先搭建一套server端，也是用dump1090，部署在Linux服务器上，然后启动：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./dump1090 --interactive --net --aggressive --net-http-port 1234 --net-only</span><br></pre></td></tr></table></figure></p>
<p>dump1090程序会自动监听30001端口。</p>
<p>然后在每个receiver上执行命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc adsb_receiver_ip 30002 | nc server_ip 30001</span><br></pre></td></tr></table></figure></p>
<p>可以将每台receiver捕获的ASAP数据通过server的30001端口进行传递。</p>
<p>我们在服务器上也执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:1234/dump1090/data.json</span><br></pre></td></tr></table></figure></p>
<p>就可以看到所有receiver传上来的数据了，一个ADS-B网络就组建好了。</p>
<p>dump1090默认是没有上传receiver的设备标识的，我们在服务器端也看不出来某条数据是来自哪个终端设备。如果终端设备很多，某些设备又出现了故障，我们很难快速定位。</p>
<p>如何给receiver增加设备标识呢？有了设备标识，dump1090自动把设备标识传给server，server端方便做数据监控。</p>
<p>我们需要改造dump1090的程序，改造<b>dump1090.h、interactive.c、net_io.c、mode_s.c</b>四个文件(+表示增加的代码)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dump1090.h</span><br><span class="line"></span><br><span class="line">struct aircraft &#123;</span><br><span class="line">    ...</span><br><span class="line">+   char          radar[20];         // marking this device</span><br><span class="line">    ...</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line">struct modesMessage &#123;</span><br><span class="line">    ...</span><br><span class="line">+    char          radar[20];        // Marking this device</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">interactive.c</span><br><span class="line"></span><br><span class="line">struct aircraft *interactiveReceiveData(struct modesMessage *mm) &#123;</span><br><span class="line">    a-&gt;timestamp = mm-&gt;timestampMsg;</span><br><span class="line">    a-&gt;messages++;</span><br><span class="line"> </span><br><span class="line">+   memcpy(a-&gt;radar, mm-&gt;radar, sizeof(a-&gt;radar));</span><br><span class="line"></span><br><span class="line">    // If a (new) CALLSIGN has been received, copy it to the aircraft structure</span><br><span class="line">    if (mm-&gt;bFlags &amp; MODES_ACFLAGS_CALLSIGN_VALID) &#123;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mode_s.c</span><br><span class="line"></span><br><span class="line">void detectModeS(uint16_t *m, uint32_t mlen) &#123;</span><br><span class="line">    // Decode the received message</span><br><span class="line">    decodeModesMessage(&amp;mm, msg);</span><br><span class="line"> </span><br><span class="line">+   // mark this device</span><br><span class="line">+   gethostname(mm.radar, sizeof(mm.radar));</span><br><span class="line"></span><br><span class="line">    // Update statistics</span><br><span class="line">    if (Modes.stats) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">net_io.c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void modesSendRawOutput(struct modesMessage *mm) &#123;</span><br><span class="line">             p += 2;</span><br><span class="line">         &#125;</span><br><span class="line">         Modes.rawOutUsed += 12; // additional 12 characters for timestamp</span><br><span class="line">+    &#125; else &#123;</span><br><span class="line">+        char *r = mm-&gt;radar;</span><br><span class="line">+        </span><br><span class="line">+        if(*r == &apos;\0&apos;)&#123;</span><br><span class="line">+            *p++ = &apos;*&apos;;</span><br><span class="line">+        &#125; else &#123;</span><br><span class="line">+            *p++ = &apos;@&apos;;</span><br><span class="line">+            </span><br><span class="line">+            int k = 0;</span><br><span class="line">+            while(*r != &apos;\0&apos;)&#123;</span><br><span class="line">+                *p++ = *r++;</span><br><span class="line">+                k ++;</span><br><span class="line">+            &#125;</span><br><span class="line">+            while(k &lt; 20)&#123;   // padding with # for length 20</span><br><span class="line">+                *p++ = &apos;#&apos;;</span><br><span class="line">+                k ++;</span><br><span class="line">+            &#125;</span><br><span class="line">+</span><br><span class="line">+            Modes.rawOutUsed += 20;</span><br><span class="line">+        &#125;</span><br><span class="line">+    &#125;</span><br><span class="line">for (j = 0; j &lt; msgLen; j++) &#123;</span><br><span class="line">         sprintf(p, &quot;%02X&quot;, mm-&gt;msg[j]);</span><br><span class="line"></span><br><span class="line">         ...</span><br><span class="line">&#125;</span><br><span class="line">+        &#125;</span><br><span class="line">+    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int decodeHexMessage(struct client *c, char *hex) &#123;</span><br><span class="line">         case &apos;@&apos;:     // No CRC check</span><br><span class="line">         case &apos;%&apos;: &#123;   // CRC is OK</span><br><span class="line">+            hex++;</span><br><span class="line">+            memcpy(mm.radar, hex, 20);</span><br><span class="line">+            char *p = mm.radar;</span><br><span class="line">+            p += 19;</span><br><span class="line">+            while(*p == &apos;#&apos;)&#123; // trim #</span><br><span class="line">+                *p-- = &apos;\0&apos;;</span><br><span class="line">+            &#125;</span><br><span class="line">+            hex += 20; l -= 22; // Skip @,%, and timestamp, and ;</span><br><span class="line">             break;&#125;</span><br><span class="line"> </span><br><span class="line">         case &apos;*&apos;:</span><br><span class="line">         case &apos;:&apos;: &#123;</span><br><span class="line">             hex++; l-=2; // Skip * and ;</span><br><span class="line">+            struct sockaddr_in addr;</span><br><span class="line">+            socklen_t addr_size = sizeof(struct sockaddr_in);</span><br><span class="line">+            getpeername(c-&gt;fd, (struct sockaddr *)&amp;addr, &amp;addr_size);</span><br><span class="line">+            strcpy(mm.radar, inet_ntoa(addr.sin_addr));</span><br><span class="line">             break;&#125;</span><br><span class="line"> </span><br><span class="line">         default: </span><br><span class="line"></span><br><span class="line">         ...</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">char *aircraftsToJson(int *len) &#123;</span><br><span class="line">     while(a) &#123;</span><br><span class="line">         int position = 0;</span><br><span class="line">         int track = 0;</span><br><span class="line">+        int ground = 0;</span><br><span class="line"> </span><br><span class="line">         if (a-&gt;modeACflags &amp; MODEAC_MSG_FLAG) &#123; // skip any fudged ICAO records Mode A/C</span><br><span class="line">             a = a-&gt;next;</span><br><span class="line">@@ -660,14 +693,19 @@ char *aircraftsToJson(int *len) &#123;</span><br><span class="line">         if (a-&gt;bFlags &amp; MODES_ACFLAGS_HEADING_VALID) &#123;</span><br><span class="line">             track = 1;</span><br><span class="line">         &#125;</span><br><span class="line">+       </span><br><span class="line">+        if ((a-&gt;bFlags &amp; MODES_ACFLAGS_AOG_GROUND) == MODES_ACFLAGS_AOG_GROUND)</span><br><span class="line">+        &#123;</span><br><span class="line">+            ground = 1;</span><br><span class="line">+        &#125;</span><br><span class="line">         </span><br><span class="line">         // No metric conversion</span><br><span class="line">         l = snprintf(p,buflen,</span><br><span class="line">             &quot;&#123;\&quot;hex\&quot;:\&quot;%06x\&quot;, \&quot;squawk\&quot;:\&quot;%04x\&quot;, \&quot;flight\&quot;:\&quot;%s\&quot;, \&quot;lat\&quot;:%f, &quot;</span><br><span class="line">             &quot;\&quot;lon\&quot;:%f, \&quot;validposition\&quot;:%d, \&quot;altitude\&quot;:%d,  \&quot;vert_rate\&quot;:%d,\&quot;track\&quot;:%d, \&quot;validtrack\&quot;:%d,&quot;</span><br><span class="line">+            &quot;\&quot;speed\&quot;:%d, \&quot;messages\&quot;:%ld, \&quot;seen\&quot;:%d,\&quot;validground\&quot;:%d,\&quot;radar\&quot;:\&quot;%s\&quot;&#125;,\n&quot;,</span><br><span class="line">             a-&gt;addr, a-&gt;modeA, a-&gt;flight, a-&gt;lat, a-&gt;lon, position, a-&gt;altitude, a-&gt;vert_rate, a-&gt;track, track,</span><br><span class="line">+            a-&gt;speed, a-&gt;messages, (int)(now - a-&gt;seen),ground,a-&gt;radar);</span><br><span class="line">         p += l; buflen -= l;</span><br><span class="line">         </span><br><span class="line">         //Resize if needed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">         ...</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>改造后的dump1090，得到的数据项里增加了<b>radar</b>字段，用了gethostname()系统调用，取的是设备主机的<b>hostname</b>。我们只需要把每台终端设备的hostname设置成不一样就可以了，不涉及到网络和其它IO操作，简单，稳定，可靠。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;hex&quot;:&quot;780e0d&quot;, &quot;squawk&quot;:&quot;0000&quot;, &quot;flight&quot;:&quot;&quot;, &quot;lat&quot;:25.137696, &quot;lon&quot;:114.456188, &quot;validposition&quot;:1, &quot;altitude&quot;:21700,  &quot;vert_rate&quot;:0,&quot;track&quot;:205, &quot;validtrack&quot;:1,&quot;speed&quot;:395, &quot;messages&quot;:13, &quot;seen&quot;:1,&quot;validground&quot;:0,&quot;radar&quot;:&quot;device888&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终附上改造后的源码：<a href="https://github.com/liaorui/dump1090" target="_blank" rel="noopener">dump1090</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      

    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/02/ADS-B简介/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liao Rui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TechLiving">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/02/ADS-B简介/" itemprop="url">ADS-B简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-02T08:18:20+08:00">
                2018-02-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/02/ADS-B简介/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/02/02/ADS-B简介/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>很多人问我，你们搞航班的数据从哪来的？我说花钱买，网上爬，装ADS-B设备收。这里简单介绍一下ADS-B。</p>
<p>先看一下维基百科的介绍：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Automatic dependent surveillance – broadcast (ADS–B) is a surveillance technology in which an aircraft determines its position via satellite navigation and periodically broadcasts it, enabling it to be tracked. </span><br><span class="line">The information can be received by air traffic control ground stations as a replacement for secondary radar as no interrogation signal is needed from the ground. </span><br><span class="line">It can also be received by other aircraft to provide situational awareness and allow self separation.</span><br><span class="line"></span><br><span class="line">ADS–B is &quot;automatic&quot; in that it requires no pilot or external input. </span><br><span class="line">It is &quot;dependent&quot; in that it depends on data from the aircraft&apos;s navigation system.</span><br></pre></td></tr></table></figure></p>
<p>大体的意思就是一种通过卫星导航来监视飞机位置的技术，它是自动向外广播的，地面站可以接收。它用的其实就是飞机上的导航系统的数据。因为它的成本低，地面空管站也会用ADS-B来替代<a href="https://en.wikipedia.org/wiki/Secondary_surveillance_radar" target="_blank" rel="noopener">二次雷达</a>。听某业内人士说，购买一套二次雷达设备要几千万费用呢，而且只能军用，禁止民用。</p>
<p>再简要的说，ADS-B就是自动报告飞机的位置（包括经纬度、高度、速度、航向、应答机编码、机尾号等），并不断向地面广播。我们在地面上装一个设备，接收这个广播就行了，就跟听收音机一样。</p>
<p>那么是不是所有的飞机都会向外发送ADS-B广播呢？目前最大的民用客机波音和空客基本上都有ADS-B设备，咱们自己的国产大飞机C919也支持ADS-B，但一些专飞支线的飞机像庞巴迪CRJ900等还不支持。从市场份额来看，目前全球和中国的90%以上的民用飞机都支持ADS-B了。FAA也在推动ADS-B成为下一代飞机位置监控的标准，并取代昂贵的雷达系统。可以认为未来所有的民用飞机都会支持ADS-B。</p>
<p>ADS-B在国外发展的如火如荼，也催生了一批专业提供ADS-B数据的公司，如Flightradar24、AirNav等。<br>他们在全球部署receiver，组装成一个全球的设备网络，全球的飞机基本都有监控到。</p>
<p><img src="/2018/02/02/ADS-B简介/adsb.jpg" alt=""></p>
<center>From flightradar24</center>


<p>更重要的是，一大批航空爱好者也加入进来。如果你是个航空爱好者，酷爱DIY，只要有一个<a href="https://www.raspberrypi.org" target="_blank" rel="noopener">Raspberry Pi</a>开发板，刷上软件，再插上一根天线，就能在自家院子里收天上飞机的位置信号，这简直太酷了。给个传送门，就像这样玩：<a href="https://github.com/openskynetwork/raspberry-pi-adsb" target="_blank" rel="noopener">raspberry-pi-adsb</a>。某宝上也有卖哦~</p>
<p><img src="/2018/02/02/ADS-B简介/assembled.jpg" alt=""></p>
<p>ADS-B广播唯一的缺点是穿透性太差，很容易受到大山和高楼建筑物的遮挡，所以recever必须部署在空旷的位置，比如楼顶。如果需要把数据共享到互联网上，还需要稳定的网络。有很多全球爱好者一起组成的大型ADS-B网络，共享彼此的数据，独乐乐不如众乐乐。</p>
<p>有ADS-B receiver设备后，还要刷软件，把天线收到的1090频率的数据进行解析，转化成我们能理解的数据，比如：经纬度、高度、速度、航向、应答机编码、机尾号等。有大神把这一套软件也提供了：<a href="https://github.com/MalcolmRobb/dump1090" target="_blank" rel="noopener">dump1090</a>。</p>
<p>刷了dump1090后，解析出来的数据格式是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;hex&quot;:&quot;780e21&quot;, &quot;squawk&quot;:&quot;3076&quot;, &quot;flight&quot;:&quot;CCA953&quot;, &quot;lat&quot;:38.711258, &quot;lon&quot;:119.635315, &quot;validposition&quot;:1, &quot;altitude&quot;:20700,  &quot;vert_rate&quot;:0,&quot;track&quot;:101, &quot;validtrack&quot;:1,&quot;speed&quot;:417, &quot;messages&quot;:155, &quot;seen&quot;:1,&quot;validground&quot;:0&#125;</span><br></pre></td></tr></table></figure></p>
<p>意思是应答机编码为780e21的这架飞机，正在20700英尺的高度飞行，位置在(38.711258,119.635315)，速度是417海里/小时。</p>
<p>国外也有免费的ADS-B数据源：<a href="https://public-api.adsbexchange.com/VirtualRadar/AircraftList.json" target="_blank" rel="noopener">ADSBExchange</a>。对，定时刷这个接口就行了，把数据解析出来，分析飞机起飞和降落的趋势，估算实际起飞时间和实际到达时间。</p>
<p>ADSBExchange给的ADS-B数据如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;Id&quot;:10697184,&quot;Rcvr&quot;:1,&quot;HasSig&quot;:true,&quot;Sig&quot;:23,&quot;Icao&quot;:&quot;A339E0&quot;,&quot;Bad&quot;:false,&quot;Reg&quot;:&quot;N307FR&quot;,&quot;FSeen&quot;:&quot;\/Date(1517527075034)\/&quot;,&quot;TSecs&quot;:7789,&quot;CMsgs&quot;:4678,&quot;Alt&quot;:35975,&quot;GAlt&quot;:36516,&quot;InHg&quot;:30.46063,&quot;AltT&quot;:0,&quot;Call&quot;:&quot;1459&quot;,&quot;Lat&quot;:37.1836,&quot;Long&quot;:-98.703978,&quot;PosTime&quot;:1517534852768,&quot;Mlat&quot;:false,&quot;Tisb&quot;:false,&quot;Spd&quot;:353.2,&quot;Trak&quot;:289.0,&quot;TrkH&quot;:false,&quot;Type&quot;:&quot;A20N&quot;,&quot;Mdl&quot;:&quot;Airbus A320 251NSL&quot;,&quot;Man&quot;:&quot;Airbus&quot;,&quot;CNum&quot;:&quot;7472&quot;,&quot;Op&quot;:&quot;Frontier Airlines&quot;,&quot;OpIcao&quot;:&quot;FFT&quot;,&quot;Sqk&quot;:&quot;4166&quot;,&quot;Help&quot;:false,&quot;Vsi&quot;:0,&quot;VsiT&quot;:0,&quot;WTC&quot;:2,&quot;Species&quot;:1,&quot;Engines&quot;:&quot;2&quot;,&quot;EngType&quot;:3,&quot;EngMount&quot;:0,&quot;Mil&quot;:false,&quot;Cou&quot;:&quot;United States&quot;,&quot;HasPic&quot;:false,&quot;Interested&quot;:false,&quot;FlightsCount&quot;:0,&quot;Gnd&quot;:false,&quot;SpdTyp&quot;:0,&quot;CallSus&quot;:false,&quot;Trt&quot;:2,&quot;Year&quot;:&quot;2016&quot;&#125;</span><br></pre></td></tr></table></figure></p>
<p>数据的定义在这里<a href="http://www.virtualradarserver.co.uk/Documentation/Formats/AircraftList.aspx" target="_blank" rel="noopener">AircraftList.json</a></p>
<p>国内最大的无人机厂商大疆公司也开始在无人机上安装ADS-B receiver了，试图解决无人机对民航客机的干扰问题: <a><a href="https://bbs.dji.com/thread-109351-1-1.html" target="_blank" rel="noopener">https://bbs.dji.com/thread-109351-1-1.html</a></a></p>
<p>我们在国内各个主要机场部署ADS-B receiver，刷上dump1090软件，自己组网，所有的receiver往server传数据，然后再解析，就拿到航班数据了。部署在机场，主要是想拿到飞机刚起飞或快要降落的低空信号，可以更准确的估算出飞机实际起飞和实际到达时间。</p>
<p>受地形影响，新疆、西藏、云贵高原等地区，基本很难通过receiver收ADS-B信号。能方便接收ADS-B信号的主要集中在华北、华东、中南，还有东北、西北、西南少部分地区。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      

    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpeg"
                alt="Liao Rui" />
            
              <p class="site-author-name" itemprop="name">Liao Rui</p>
              <p class="site-description motion-element" itemprop="description">Java</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liao Rui</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'gBKAh0rYcnxSinc8tu0HIpLg-gzGzoHsz',
        appKey: 'mIuTlwW0NmX5kNaFXMqCCEPi',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
